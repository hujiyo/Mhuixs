# Logex

一个支持布尔运算、数值计算和变量机制的数学脚本语言解释器。

> **名称由来**：Logex = Logic + Expression，同时与《三体》中的"罗辑"谐音，寓意逻辑推理与表达式求值的完美融合。

## 特性

### 🎯 核心功能

- ✅ **任意精度数值计算**：支持大整数和高精度小数运算
- ✅ **布尔逻辑运算**：完整的逻辑运算支持（AND, OR, NOT, XOR, IMPLIES, IFF）
- ✅ **类型无缝转换**：数值与布尔值自动转换（非零为真，零为假）
- ✅ **变量机制**：支持变量定义、引用和复杂表达式
- ✅ **包管理系统**：自动化的函数库加载机制，零配置扩展
1. **零配置扩展**：只需将 `.so` 文件放入 `package/` 目录
2. **无需重新编译**：添加新包不需要重新编译计算器
3. **模块化设计**：每个包独立开发、独立编译
4. **按需加载**：只加载需要的包，节省内存
- ✅ **函数调用**：支持数学函数和自定义函数
- ✅ **交互式 REPL**：友好的命令行交互界面

### 📐 支持的运算

#### 数值运算符
- `+`, `-`, `*`, `/` - 加减乘除
- `**` - 幂运算（右结合）
- `%` - 取模运算

#### 比较运算符
- `==` - 等于
- `!=` - 不等于
- `>` - 大于
- `>=` - 大于等于
- `<` - 小于
- `<=` - 小于等于

#### 布尔运算符
- `^` - 合取 (AND)
- `v` - 析取 (OR)
- `!` - 否定 (NOT)
- `→` - 蕴含 (IMPLIES)
- `↔` - 等价 (IFF)
- `⊽` - 异或 (XOR)

#### 运算符优先级表

| 优先级 | 运算符 | 解析函数 | 结合性 |
|--------|--------|----------|--------|
| 1 (最低) | ⊽ (XOR) | parse_xor | 左结合 |
| 2 | ↔ (IFF) | parse_iff | 左结合 |
| 3 | → (IMPLIES) | parse_impl | 左结合 |
| 4 | v (OR) | parse_or | 左结合 |
| 5 | ^ (AND) | parse_and | 左结合 |
| 6 | ==, !=, <, <=, >, >= | parse_comparison | 左结合 |
| 7 | +, - | parse_add_sub | 左结合 |
| 8 | *, /, % | parse_term | 左结合 |
| 9 | ** (幂) | parse_power | **右结合** |
| 10 (最高) | !, 一元-, +, 括号, 原子 | parse_primary | - |

### 表达式求值流程

```
用户输入 "let X = 5 + 3"
    ↓
[Calculator] 读取输入
    ↓
[Evaluator] eval_statement()
    ↓
[Lexer] Token 流: LET, IDENTIFIER("X"), ASSIGN, NUMBER("5"), PLUS, NUMBER("3")
    ↓
[Evaluator] 识别为赋值语句
    ↓
[Evaluator] parse_expression("5 + 3")
    ↓
[BigNum] 计算 5 + 3 = 8
    ↓
[Context] context_set("X", 8)
    ↓
[Calculator] 输出 "X = 8"
```

### 📦 变量机制

支持类似脚本语言的变量定义和使用：

```
let A = 1          # 定义变量 A
let B = 0          # 定义变量 B
A ^ B              # 使用变量：结果 0
let C = A v B      # 变量可用于表达式
C                  # 显示变量值：1
```

### 📝 字符串类型支持（新特性！）

Logex 支持字符串类型，通过 `string` 包提供类型转换功能：

```bash
# 导入 string 包
expr > import string
已导入 string 包 (2 个函数)

# 定义字符串变量
expr > let price = "99.99"
price = "99.99"

# 使用 num() 转换为数字进行计算
expr > num(price) * 2
= 199.98

# 使用 str() 转换回字符串
expr > str(42)
= "42"
```

**重要**：字符串和数字是严格区分的类型，算术运算**不会自动转换**，必须使用 `num()` 和 `str()` 显式转换。

详见：[字符串类型指南](./STRING_TYPE_GUIDE.md) | [更新日志](./CHANGELOG_STRING.md)

### 🔌 包管理系统（新特性！）

**零配置的函数库扩展系统**，只需将包文件放入 `package/` 目录即可使用：

```bash
# 查看可用的包
expr > packages
可用的包：
  math
  example

# 导入包
expr > import math
已导入 math 包 (22 个函数)

# 使用函数
expr > sin(π/2)
= 1

expr > sqrt(16)
= 4

# 导入其他包
expr > import example
已导入 example 包 (3 个函数)

expr > double(5)
= 10
```

**内置包**：
- **math**: 22个数学函数（三角、对数、指数、取整等）+ 常量（π, e, φ）
- **string**: 2个类型转换函数（num, str），支持字符串和数字互转
- **example**: 3个示例函数（double, triple, square）

**开发自己的包**：只需实现 `package_register()` 函数，编译为 `.so` 文件即可！

详见：[包开发指南](./PACKAGE_GUIDE.md) | [包使用说明](./README_PACKAGE.md) | [字符串类型指南](./STRING_TYPE_GUIDE.md) | [完整演示](./DEMO.md)

## 代码架构

### 模块设计

项目采用**分层模块化架构**，职责清晰，易于扩展：

```
┌─────────────────────────────────────────┐
│         calculator.c (REPL)             │  # 用户交互层
│  - 命令行界面                            │
│  - 输入处理                              │
│  - 结果显示                              │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       evaluator.c (求值器)               │  # 语义分析与求值层
│  - 递归下降解析                          │
│  - 表达式求值                            │
│  - 赋值语句处理                          │
└──────┬───────────────┬──────────────────┘
       │               │
┌──────▼─────┐  ┌──────▼──────────────────┐
│  lexer.c   │  │    context.c            │  # 支持层
│  (词法)    │  │    (变量上下文)         │
│  - Token化 │  │  - 变量存储             │
│  - 关键字  │  │  - 变量查询             │
└──────┬─────┘  └─────────────────────────┘
       │
┌──────▼──────────────────────────────────┐
│         bignum.c (大数运算)              │  # 基础计算层
│  - 任意精度算术                          │
│  - 加减乘除、幂、取模                    │
└─────────────────────────────────────────┘
```

## 📁 项目结构

```
booleval/
├── package.h              # 包管理器头文件
├── package.c              # 包管理器实现
├── function.h             # 函数注册机制接口
├── bignum.h               # 大数运算接口
├── context.h              # 变量上下文接口
├── lexer.h                # 词法分析器接口
├── calculator.c           # 主程序（已修改）
├── evaluator.c            # 求值器（已修改）
├── evaluator.h            # 求值器接口
├── lexer.c                # 词法分析器
├── context.c              # 变量上下文
├── bignum.c               # 大数运算
├── Makefile               # 编译脚本（已修改）
├── package/               # 包目录
│   ├── math_package.c     # Math 包源码
│   ├── example_package.c  # Example 包源码
│   ├── libmath.so         # Math 包（编译后）
│   └── libexample.so      # Example 包（编译后）
└── 文档/
    ├── PACKAGE_GUIDE.md
    ├── README_PACKAGE.md
    ├── DEMO.md
    └── CHANGELOG_PACKAGE.md
```

### 核心模块说明

#### 1. **Lexer（词法分析器）** - `lexer.c/lexer.h`
- 将输入字符串分解为 Token 流
- 识别数字、标识符、运算符、关键字
- 特殊处理：`v` 作为保留关键字（OR 运算符）

#### 2. **Evaluator（求值器）** - `evaluator.c/evaluator.h`
- 递归下降解析器，按运算符优先级构建
- 优先级（从高到低）：
  1. 括号 `()`
  2. 一元运算符 `!`, 负号
  3. 幂运算 `**`
  4. 乘除取模 `*`, `/`, `%`
  5. 加减 `+`, `-`
  6. 比较 `==`, `!=`, `>`, `>=`, `<`, `<=`
  7. 逻辑 `^`, `v`, `→`, `↔`, `⊽`
- 支持变量引用和表达式求值

#### 3. **Context（变量上下文）** - `context.c/context.h`
- 哈希表式的变量存储
- 支持变量的 CRUD 操作
- 最多支持 256 个变量

#### 4. **BigNum（大数运算）** - `bignum.c/bignum.h`
- 任意精度整数和小数
- 默认精度：100 位小数
- 最大位数：10000 位

## 编译与运行

### 编译计算器

```bash
make          # 编译计算器
make clean    # 清理编译文件
make rebuild  # 重新编译
```

### 编译包（独立项目）

包系统是独立的项目，有自己的构建系统：

```bash
cd package    # 进入包目录
make          # 编译所有包
make clean    # 清理包文件
make help     # 查看帮助
```

### 运行

```bash
./calculator  # 启动交互式计算器
make run      # 等同于上面
```

### 测试

```bash
./test_variables.sh  # 运行变量机制测试
```

## 使用示例

### 基础计算

```
expr > 123.456 + 789
= 912.456

expr > 2 ** 10
= 1024

expr > 17 % 5
= 2
```

### 布尔运算

```
expr > 1 ^ 0
= 0

expr > 1 v 0
= 1

expr > !1
= 0

expr > 1 → 0
= 0
```

### 混合运算

```
expr > (5 > 3) * 100
= 100

expr > (10 - 10) v 1
= 1

expr > 2 + (1 ^ 1)
= 3
```

### 变量使用

```
expr > let A = 1
A = 1

expr > let B = 0
B = 0

expr > A ^ B
= 0

expr > let C = A v B
C = 1

expr > let X = 5
X = 5

expr > let Y = X * 2
Y = 10

expr > Y + 1
= 11

expr > let result = (X > 3) ^ (Y == 10)
result = 1

expr > vars
已定义变量：
  A = 1
  B = 0
  C = 1
  X = 5
  Y = 10
  result = 1
```

## 命令参考

### 交互式命令

- `help` - 显示帮助信息
- `vars` - 列出所有变量
- `clear` - 清空所有变量
- `exit` / `quit` - 退出程序

### 快捷键

- `↑` / `↓` - 切换运算符（智能预测）
- `Backspace` - 删除字符
- `Ctrl+C` - 退出

## 架构设计要点

### 为什么这样设计？

1. **模块分层清晰**
   - 每个模块只负责一件事
   - 降低耦合，提高内聚
   - 便于测试和维护

2. **递归下降解析**
   - 代码直观，易于理解
   - 扩展新运算符只需添加一个解析函数
   - 自然支持运算符优先级

3. **Context 模块独立**
   - 变量管理与求值逻辑分离
   - 未来可轻松扩展（作用域、类型系统等）
   - 支持多上下文（如函数调用栈）

4. **void* 接口设计**
   - Evaluator 不直接依赖 Context 结构
   - 降低模块间耦合
   - 便于未来扩展其他上下文类型

### 扩展方向

基于当前架构，未来可轻松扩展：

- ✨ **函数定义**：`def f(x) = x * 2`
- ✨ **控制流**：`if`、`while`、`for`
- ✨ **数组/列表**：`[1, 2, 3]`
- ✨ **字符串**：`"hello"`
- ✨ **模块系统**：`import math`
- ✨ **类型系统**：静态类型检查
- ✨ **作用域**：局部变量、全局变量

## 设计优势

### 降低复杂度

1. **职责单一**：每个模块只做一件事
2. **接口清晰**：模块间通过明确的 API 交互
3. **无循环依赖**：单向依赖链
4. **易于测试**：每个模块可独立测试


## 性能

- 大数运算：支持 10000 位数字
- 变量容量：最多 256 个变量
- 小数精度：默认 100 位（可配置）
- 表达式深度：受栈限制（通常足够深）

## 🎯 按需求查找文档

### 我想使用内置的包
👉 阅读：[README_PACKAGE.md](./README_PACKAGE.md)

### 我想看实际使用案例
👉 阅读：[DEMO.md](./DEMO.md)

### 我想开发自己的包
👉 阅读：[PACKAGE_GUIDE.md](./PACKAGE_GUIDE.md)

### 我遇到了问题
👉 查看：[README_PACKAGE.md](./README_PACKAGE.md) 的故障排查部分

## 🎓 学习路径

### 用户路径
1. [README.md](./README.md) - 了解基本功能
2. [README_PACKAGE.md](./README_PACKAGE.md) - 了解包的使用方式

### 包开发者路径
0. 用户路径完成
1. [PACKAGE_GUIDE.md](./PACKAGE_GUIDE.md) - 学习包开发方式
2. [package/example_package.c](./package/example_package.c) - 参考示例

### 深入研究路径
0. 包开发者路径完成
1. 阅读词法分析器、包管理器、求值器、大数运算、变量上下文等源码


## 许可证

本项目采用开源许可证。

## 贡献

欢迎提交 Issue 和 Pull Request！

---

**设计理念**：简单、清晰、可扩展

构建于 2025 年，专注于代码质量和架构设计。

